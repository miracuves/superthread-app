import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../presentation/bloc/auth/auth_bloc.dart';
import '../../presentation/bloc/auth/auth_state.dart';
import '../../presentation/pages/auth/splash_screen.dart';
import '../../presentation/pages/auth/login_screen.dart';
import '../../presentation/pages/dashboard/dashboard_screen.dart';
import '../../presentation/pages/dashboard/home_screen.dart';
import '../../presentation/pages/dashboard/projects_screen.dart';
import '../../presentation/pages/dashboard/cards_screen.dart';
import '../../presentation/pages/dashboard/notes_screen.dart';
import '../../presentation/pages/dashboard/search_screen.dart';
import '../../presentation/pages/dashboard/profile_screen.dart';
import '../../presentation/pages/kanban/kanban_board_screen.dart';
import '../../presentation/pages/project_detail_screen.dart';
import '../../presentation/pages/card_detail_screen.dart';
import '../../presentation/pages/note_detail_screen.dart';
import '../../presentation/pages/settings_screen.dart';

/// App Router Configuration
class AppRouter {
  final AuthBloc authBloc;
  bool get initialized => _router != null;
  GoRouter? _router;

  AppRouter({required this.authBloc}) {
    _router = GoRouter(
      initialLocation: '/splash',
      debugLogDiagnostics: true,
      redirect: (context, state) {
        final authState = authBloc.state;
        final location = state.uri.toString();

        // If not authenticated and not on auth pages, redirect to login
        if (authState is! Authenticated &&
            !location.startsWith('/splash') &&
            !location.startsWith('/login')) {
          return '/login';
        }

        // If authenticated and on auth pages, redirect to dashboard
        if (authState is Authenticated &&
            (location.startsWith('/splash') ||
             location.startsWith('/login'))) {
          return '/dashboard';
        }

        return null;
      },
    routes: [
      // Splash Screen
      GoRoute(
        path: '/splash',
        name: 'splash',
        builder: (context, state) => const SplashScreen(),
      ),

      // Authentication Routes
      GoRoute(
        path: '/login',
        name: 'login',
        builder: (context, state) => const LoginScreen(),
      ),

      // Dashboard Routes (Shell Route)
      ShellRoute(
        builder: (context, state, child) {
          return DashboardScreen(
            currentIndex: _getTabIndexFromPath(state.uri.toString()),
            child: child,
          );
        },
        routes: [
          // Home Tab
          GoRoute(
            path: '/dashboard',
            name: 'dashboard',
            builder: (context, state) => const HomeScreen(),
          ),

          // Projects Tab
          GoRoute(
            path: '/projects',
            name: 'projects',
            builder: (context, state) => const ProjectsScreen(),
            routes: [
              // Project Detail
              GoRoute(
                path: '/project/:id',
                name: 'project-detail',
                builder: (context, state) {
                  final projectId = state.pathParameters['id']!;
                  return ProjectDetailScreen(projectId: projectId);
                },
                routes: [
                  // Kanban Board
                  GoRoute(
                    path: '/kanban',
                    name: 'kanban-board',
                    builder: (context, state) {
                      final projectId = state.pathParameters['id']!;
                      return KanbanBoardScreen(projectId: projectId);
                    },
                  ),
                ],
              ),
            ],
          ),

          // Cards Tab
          GoRoute(
            path: '/cards',
            name: 'cards',
            builder: (context, state) => const CardsScreen(),
            routes: [
              // Card Detail
              GoRoute(
                path: '/card/:id',
                name: 'card-detail',
                builder: (context, state) {
                  final cardId = state.pathParameters['id']!;
                  return CardDetailScreen(cardId: cardId);
                },
              ),
              // Create Card
              GoRoute(
                path: '/create',
                name: 'create-card',
                builder: (context, state) => CardDetailScreen(
                  cardId: null,
                  boardId: state.uri.queryParameters['boardId'],
                ),
              ),
            ],
          ),

          // Notes Tab
          GoRoute(
            path: '/notes',
            name: 'notes',
            builder: (context, state) => const NotesScreen(),
            routes: [
              // Note Detail
              GoRoute(
                path: '/note/:id',
                name: 'note-detail',
                builder: (context, state) {
                  final noteId = state.pathParameters['id']!;
                  return NoteDetailScreen(noteId: noteId);
                },
              ),
              // Create Note
              GoRoute(
                path: '/create',
                name: 'create-note',
                builder: (context, state) => const NoteDetailScreen(noteId: null),
              ),
            ],
          ),

          // Search Tab
          GoRoute(
            path: '/search',
            name: 'search',
            builder: (context, state) => const SearchScreen(),
            routes: [
              // Search Results
              GoRoute(
                path: '/results/:query',
                name: 'search-results',
                builder: (context, state) {
                  return SearchScreen(
                    query: state.pathParameters['query']!,
                  );
                },
              ),
            ],
          ),

          // Profile Tab
          GoRoute(
            path: '/profile',
            name: 'profile',
            builder: (context, state) => const ProfileScreen(),
            routes: [
              // Settings
              GoRoute(
                path: '/settings',
                name: 'settings',
                builder: (context, state) => const SettingsScreen(),
                routes: [
                  // Specific Settings Pages
                  GoRoute(
                    path: '/appearance',
                    name: 'appearance-settings',
                    builder: (context, state) => const SettingsScreen(
                      initialSection: 'appearance',
                    ),
                  ),
                  GoRoute(
                    path: '/account',
                    name: 'account-settings',
                    builder: (context, state) => const SettingsScreen(
                      initialSection: 'account',
                    ),
                  ),
                  GoRoute(
                    path: '/security',
                    name: 'security-settings',
                    builder: (context, state) => const SettingsScreen(
                      initialSection: 'security',
                    ),
                  ),
                ],
              ),
            ],
          ),
        ],
      ),

      // Global Routes (outside shell)
      GoRoute(
        path: '/settings-global',
        name: 'settings-global',
        builder: (context, state) => const SettingsScreen(),
      ),

      // Deep linking for specific resources
      GoRoute(
        path: '/card/:id',
        name: 'card-direct',
        builder: (context, state) {
          final cardId = state.pathParameters['id']!;
          return BlocBuilder<AuthBloc, AuthState>(
            builder: (context, authState) {
              if (authState is Authenticated) {
                return DashboardScreen(
                  currentIndex: 2, // Cards tab
                  child: CardDetailScreen(cardId: cardId),
                );
              }
              return const LoginScreen();
            },
          );
        },
      ),

      GoRoute(
        path: '/note/:id',
        name: 'note-direct',
        builder: (context, state) {
          final noteId = state.pathParameters['id']!;
          return BlocBuilder<AuthBloc, AuthState>(
            builder: (context, authState) {
              if (authState is Authenticated) {
                return DashboardScreen(
                  currentIndex: 3, // Notes tab
                  child: NoteDetailScreen(noteId: noteId),
                );
              }
              return const LoginScreen();
            },
          );
        },
      ),
    ],

    // Error handling
    errorBuilder: (context, state) => Scaffold(
      appBar: AppBar(
        title: const Text('Page Not Found'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.red,
            ),
            const SizedBox(height: 16),
            const Text(
              'Page not found',
              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 8),
            Text(
              'Could not find a page for path: ${state.uri.toString()}',
              style: const TextStyle(fontSize: 16),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.go('/dashboard'),
              child: const Text('Go Home'),
            ),
          ],
        ),
      ),
    ),
  );

  GoRouter get router => _router!;
}

/// Navigation Helper Class
class NavigationHelper {
  static final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

  static BuildContext? get context => navigatorKey.currentContext;

  // Dashboard Navigation
  static void goHome() => context?.go('/dashboard');
  static void goProjects() => context?.go('/projects');
  static void goCards() => context?.go('/cards');
  static void goNotes() => context?.go('/notes');
  static void goSearch() => context?.go('/search');
  static void goProfile() => context?.go('/profile');

  // Resource Navigation
  static void goProjectDetail(String projectId) => context?.go('/projects/project/$projectId');
  static void goKanbanBoard(String projectId) => context?.go('/projects/project/$projectId/kanban');
  static void goCardDetail(String cardId) => context?.go('/cards/card/$cardId');
  static void goNoteDetail(String noteId) => context?.go('/notes/note/$noteId');

  // Creation Navigation
  static void goCreateCard({String? boardId}) {
    final query = boardId != null ? '?boardId=$boardId' : '';
    context?.go('/cards/create$query');
  }

  static void goCreateNote() => context?.go('/notes/create');

  // Settings Navigation
  static void goSettings() => context?.go('/profile/settings');
  static void goAppearanceSettings() => context?.go('/profile/settings/appearance');
  static void goAccountSettings() => context?.go('/profile/settings/account');
  static void goSecuritySettings() => context?.go('/profile/settings/security');

  // Search Navigation
  static void goSearchResults(String query, {String? type}) {
    final queryType = type != null ? '?type=$type' : '';
    context?.go('/search/results/$query$queryType');
  }

  // Utility Methods
  static void pop() => context?.pop();

  static void showSnackBar(String message) {
    final scaffoldMessenger = context?.findAncestorWidgetOfExactType<ScaffoldMessengerState>();
    if (context != null) {
      ScaffoldMessenger.of(context!).showSnackBar(
        SnackBar(content: Text(message)),
      );
    }
  }

  // Deep Linking
  static bool handleDeepLink(String link) {
    final uri = Uri.parse(link);

    switch (uri.path) {
      case '/dashboard':
        goHome();
        return true;
      case '/projects':
        goProjects();
        return true;
      case '/cards':
        goCards();
        return true;
      case '/notes':
        goNotes();
        return true;
      default:
        // Handle resource-specific deep links
        final cardMatch = RegExp(r'/card/([^/]+)').firstMatch(uri.path);
        if (cardMatch != null) {
          goCardDetail(cardMatch.group(1)!);
          return true;
        }

        final noteMatch = RegExp(r'/note/([^/]+)').firstMatch(uri.path);
        if (noteMatch != null) {
          goNoteDetail(noteMatch.group(1)!);
          return true;
        }

        return false;
    }
  }
}

/// Get tab index from path for bottom navigation
int _getTabIndexFromPath(String path) {
  if (path.startsWith('/dashboard') || path == '/') return 0;
  if (path.startsWith('/projects')) return 1;
  if (path.startsWith('/cards')) return 2;
  if (path.startsWith('/notes')) return 3;
  if (path.startsWith('/search')) return 4;
  if (path.startsWith('/profile')) return 5;
  return 0;
}
}